<!DOCTYPE html>
<html lang="en" th:lang="${language}" th:class="|tw-${theme}|" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="_layout::head(~{::title}, ~{::styles}, ~{::scripts})">
    <title th:text="#{applications.statistics.header.title}">Abwesenheitsstatistik</title>
    <th:block th:fragment="styles">
      <link
        rel="stylesheet"
        type="text/css"
        asset:href="account_form~app_form~app_statistics~overtime_form~sick_note_form~sick_notes~workingtime_form.css"
      />
      <link
        rel="stylesheet"
        type="text/css"
        asset:href="account_form~app_form~app_statistics~overtime_form~person_overview~sick_note_form~sick_notes~workingtime_form.css"
      />
    </th:block>
    <th:block th:fragment="scripts">
      <script defer asset:src="npm.duetds.js"></script>
      <script defer asset:src="npm.date-fns.js"></script>
      <script defer asset:src="npm.hotwired.js"></script>
      <script defer asset:src="app_statistics~persons.js"></script>
      <script
        defer
        asset:src="account_form~app_form~app_statistics~overtime_form~sick_note_form~sick_notes~workingtime_form.js"
      ></script>
      <script
        defer
        asset:src="account_form~app_form~app_statistics~overtime_form~person_overview~sick_note_form~sick_notes~workingtime_form.js"
      ></script>
      <script
        defer
        asset:src="account_form~app_detail~app_form~app_statistics~common~overtime_form~person_overview~sick_note_form~~ac852a85.js"
      ></script>
      <script defer asset:src="app_statistics.js"></script>
      <script th:replace="fragments/datepicker-localization :: datepicker-localization"></script>
    </th:block>
  </head>
  <body th:replace="_layout::body(~{::main}, ~{})">
    <main th:fragment="main" data-turbo="true">
      <div class="tw-max-w-[93.75rem] tw-mx-auto tw-px-4 lg:tw-px-12 xl:tw-px-8">
        <div
          th:replace="fragments/section-heading::section-heading(~{::absences-statistics-heading-body}, ~{::absences-statistics-heading-actions})"
        >
          <th:block th:ref="absences-statistics-heading-body">
            <h1 th:text="#{applications.statistics}">Abwesenheitsstatistik</h1>
          </th:block>
          <th:block th:ref="absences-statistics-heading-actions">
            <a
              th:href="@{/web/application/statistics/download?from={fromIso}&to={toIso}(fromIso=${from}, toIso=${to})}"
              class="icon-link tw-px-1"
              th:data-title="#{action.download}"
            >
              <svg th:replace="icon/download::svg(className='tw-w-5 tw-h-5')"></svg>
              <span class="tw-sr-only" th:text="#{action.download}"></span>
            </a>
            <button th:replace="fragments/print::button"></button>
          </th:block>
        </div>

        <div class="tw-flex tw-flex-col md:tw-flex-row tw-gap-4">
          <form method="get" action="#" th:action="@{/web/application/statistics}">
            <div id="statistics-filter-inputs">
              <input type="hidden" name="sort" th:value="${sortQuery}" />
            </div>
            <div class="tw-flex tw-flex-col sm:tw-flex-row sm:tw-items-center tw-gap-4">
              <div class="tw-flex tw-flex-col sm:tw-flex-row sm:tw-items-center tw-gap-y-1 tw-gap-x-2">
                <label th:text="|#{filter.period.startDate}: |" for="from-date-input" class="tw-m-0" />
                <input
                  id="from-date-input"
                  name="from"
                  th:value="${{period.startDate}}"
                  th:data-iso-value="${period.startDateIsoValue}"
                  th:placeholder="#{pattern.date}"
                  class="form-control"
                />
              </div>
              <div class="tw-flex tw-flex-col sm:tw-flex-row sm:tw-items-center tw-gap-y-1 tw-gap-x-2">
                <label th:text="|#{filter.period.endDate}: |" for="to-date-input" class="tw-m-0" />
                <input
                  id="to-date-input"
                  name="to"
                  th:value="${{period.endDate}}"
                  th:data-iso-value="${period.endDateIsoValue}"
                  th:placeholder="#{pattern.date}"
                  class="form-control"
                />
              </div>
              <div>
                <button th:text="#{action.confirm}" class="button-main tw-py-1.5 tw-px-3" type="submit" />
              </div>
            </div>
          </form>
          <div class="md:tw-ml-auto">
            <form
              action="#"
              th:action="@{/web/application/statistics}"
              method="get"
              data-turbo-frame="frame-statistics"
              data-turbo-action="advance"
            >
              <div id="statistics-form-sort-inputs">
                <input type="hidden" name="from" th:value="${period.startDateIsoValue}" />
                <input type="hidden" name="to" th:value="${period.endDateIsoValue}" />
                <input type="hidden" name="size" th:value="${statisticsPage.size}" />
              </div>
              <div class="tw-flex tw-flex-col md:tw-flex-row md:tw-items-center">
                <label for="sort-select" class="tw-m-0 tw-mr-2">
                  <th:block th:text="#{action.sort}">Sortieren</th:block>:
                </label>
                <select
                  id="sort-select"
                  name="sort"
                  th:replace="fragments/select::one(id='sort-select', name='sort', options=~{::sort-select-options}, autosubmit='sort-submit')"
                >
                  <th:block th:ref="sort-select-options">
                    <optgroup
                      th:each="optgroup : ${sortSelect.optgroups}"
                      th:label="${#messages.msg(optgroup.labelMessageKey)}"
                    >
                      <option
                        th:each="option : ${optgroup.options}"
                        th:value="${option.value}"
                        th:text="${#messages.msg(option.textMessageKey)}"
                        th:selected="${option.selected}"
                      ></option>
                    </optgroup>
                  </th:block>
                </select>
                <button
                  type="submit"
                  id="sort-submit"
                  class="tw-ml-2 button-main"
                  th:text="#{action.sort}"
                  data-js-hidden
                >
                  Sortieren
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="tw-mt-8 feedback" th:if="${filterPeriodIncorrect}">
          <div th:text="#{filter.period.incorrect.warning}" class="alert alert-warning"></div>
        </div>

        <div th:if="${errors}" th:text="#{applications.statistics.error}" class="tw-mt-8 alert alert-danger"></div>

        <turbo-frame id="frame-statistics">
          <th:block th:if="${turboFrameRequested}">
            <turbo-stream target="statistics-filter-inputs" action="replace">
              <template th:insert="::#statistics-filter-inputs"></template>
            </turbo-stream>
            <turbo-stream target="statistics-form-sort-inputs" action="replace">
              <template th:insert="::#statistics-form-sort-inputs"></template>
            </turbo-stream>
            <turbo-stream target="pagination" action="replace">
              <template th:insert="::#pagination"></template>
            </turbo-stream>
            <turbo-stream target="pagination-form-size-inputs" action="replace">
              <template th:insert="::#pagination-form-size-inputs"></template>
            </turbo-stream>
            <turbo-stream target="pagination-size-hint" action="replace">
              <template th:insert="::#pagination-size-hint"></template>
            </turbo-stream>
          </th:block>
          <table
            th:unless="${errors}"
            id="application-statistic-table"
            class="tw-mt-8 md:tw-mt-16 list-table tw-text-sm">

            <thead class="tw-hidden lg:tw-table-header-group">
              <tr>
                <th scope="col"></th>
                <th
                  th:if="${showPersonnelNumberColumn}"
                  scope="col"
                  class="tw-hidden lg:tw-table-cell print:tw-table-cell "
                  th:text="#{person.account.basedata.personnelNumber.abbreviation}"
                ></th>
                <th
                  scope="col"
                  class="tw-hidden lg:tw-table-cell print:tw-table-cell "
                  th:text="#{person.data.firstName}"
                ></th>
                <th
                  scope="col"
                  class="tw-hidden lg:tw-table-cell print:tw-table-cell "
                  th:text="#{person.data.lastName}"
                ></th>
                <th scope="col" class="lg:tw-hidden print:tw-hidden"></th>
                <th scope="col" class="md:tw-hidden print:tw-hidden"></th>
                <th scope="col" class="tw-hidden md:tw-table-cell print:tw-table-cell"></th>
                <th
                  scope="col"
                  class="tw-hidden md:tw-table-cell print:tw-table-cell "
                  th:text="#{applications.statistics.allowed}"
                ></th>
                <th
                  scope="col"
                  class="tw-hidden md:tw-table-cell print:tw-table-cell "
                  th:text="#{applications.statistics.waiting}"
                ></th>
                <th
                  scope="col"
                  class="tw-hidden md:tw-table-cell print:tw-table-cell "
                  th:text="#{applications.statistics.left}"
                ></th>
                <th
                  scope="col"
                  class="tw-hidden md:tw-table-cell print:tw-table-cell "
                  th:text="|#{applications.statistics.left} (${from.year})|"
                ></th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="statistic : ${statisticsPage.content}">
                <td class="tw-text-center">
                  <div class="print:tw-hidden tw-text-blue-50 dark:tw-text-sky-800">
                    <img
                      th:replace="fragments/avatar::avatar-bordered(url=${statistic.gravatarURL + '?d=404&s=60'},niceName=${statistic.niceName},width='60px',height='60px')"
                      alt=""
                      src=""
                    />
                  </div>
                </td>
                <td
                  th:if="${showPersonnelNumberColumn}"
                  th:text="${statistic.personnelNumber}"
                  class="tw-hidden lg:tw-table-cell print:tw-table-cell tw-text-ellipsis tw-overflow-hidden tw-max-w-xs tw-text-center"
                ></td>
                <td th:text="${statistic.firstName}" class="tw-hidden lg:tw-table-cell print:tw-table-cell"></td>
                <td th:text="${statistic.lastName}" class="tw-hidden lg:tw-table-cell print:tw-table-cell"></td>
                <td th:text="${statistic.niceName}" class="lg:tw-hidden print:tw-hidden"></td>
                <td class="md:tw-hidden print:tw-hidden">
                  <div class="tw-flex tw-items-center">
                    <span class="tw-w-6">
                      <svg th:replace="icon/check::svg(className='tw-w-5 tw-h-5')"></svg>
                    </span>
                    <span
                      th:text="${statistic.totalAllowedVacationDays} % 1 == 0 ? ${#numbers.formatDecimal(statistic.totalAllowedVacationDays, 1, 0)} : ${#numbers.formatDecimal(statistic.totalAllowedVacationDays, 1, 1)}"
                    ></span>
                  </div>
                  <div class="tw-flex tw-items-center">
                    <span class="tw-w-6">
                      <svg th:replace="icon/question-mark-circle::svg(className='tw-w-4 tw-h-4')"></svg>
                    </span>
                    <span
                      class="tw-font-bold"
                      th:text="${statistic.totalWaitingVacationDays} % 1 == 0 ? ${#numbers.formatDecimal(statistic.totalWaitingVacationDays, 1, 0)} : ${#numbers.formatDecimal(statistic.totalWaitingVacationDays, 1, 1)}"
                    ></span>
                  </div>
                </td>

                <td class="tw-hidden md:tw-table-cell print:tw-table-cell">
                  <span th:text="|#{applications.statistics.total}:|" class="tw-inline-block"></span>
                  <div
                    class="tw-whitespace-nowrap"
                    th:each="type : ${vacationTypes}"
                    th:if="${statistic.hasVacationType(type)}"
                  >
                    <span class="tw-text-xs" th:text="|#{${type.messageKey}}:|"></span>
                  </div>
                </td>

                <td
                  class="tw-hidden md:tw-table-cell print:tw-table-cell"

                >
                  <div class="tw-whitespace-nowrap">
                    <span
                      class="tw-font-bold"
                      th:text="${statistic.totalAllowedVacationDays} % 1 == 0 ? ${#numbers.formatDecimal(statistic.totalAllowedVacationDays, 1, 0)} : ${#numbers.formatDecimal(statistic.totalAllowedVacationDays, 1, 1)}"
                    ></span>
                    <span th:text="#{duration.days}"></span>
                  </div>
                  <div
                    class="tw-whitespace-nowrap"
                    th:if="${statistic.hasVacationType(type)}"
                    th:each="type : ${vacationTypes}"
                  >
                    <span
                      class="tw-text-xs"
                      th:text="${statistic.getAllowedVacationDays(type)} % 1 == 0 ? ${#numbers.formatDecimal(statistic.getAllowedVacationDays(type), 1, 0)} : ${#numbers.formatDecimal(statistic.getAllowedVacationDays(type), 1, 1)}"
                    ></span>
                  </div>
                </td>

                <td
                  class="tw-hidden md:tw-table-cell print:tw-table-cell"

                >
                  <div class="tw-whitespace-nowrap">
                    <span
                      class="tw-font-bold"
                      th:text="${statistic.totalWaitingVacationDays} % 1 == 0 ? ${#numbers.formatDecimal(statistic.totalWaitingVacationDays, 1, 0)} : ${#numbers.formatDecimal(statistic.totalWaitingVacationDays, 1, 1)}"
                    ></span>
                    <span th:text="#{duration.days}"></span>
                  </div>
                  <div
                    class="tw-whitespace-nowrap"
                    th:if="${statistic.hasVacationType(type)}"
                    th:each="type : ${vacationTypes}"
                  >
                    <span
                      class="tw-text-xs"
                      th:text="${statistic.getWaitingVacationDays(type)} % 1 == 0 ? ${#numbers.formatDecimal(statistic.getWaitingVacationDays(type), 1, 0)} : ${#numbers.formatDecimal(statistic.getWaitingVacationDays(type), 1, 1)}"
                    ></span>
                  </div>
                </td>

                <td
                  class="tw-hidden md:tw-table-cell print:tw-table-cell"

                >
                  <div>
                    <span
                      class="tw-font-bold"
                      th:text="${statistic.leftVacationDaysForPeriod} % 1 == 0 ? ${#numbers.formatDecimal(statistic.leftVacationDaysForPeriod, 1, 0)} : ${#numbers.formatDecimal(statistic.leftVacationDaysForPeriod, 1, 1)}"
                    ></span>
                    <span th:text="#{duration.vacationDays}"></span>
                  </div>
                  <div class="tw-text-xs">
                    <span th:text="#{duration.vacationDays.remaining.one}"></span>
                    <span
                      class="tw-font-bold"
                      th:text="${statistic.remainingLeftVacationDaysForPeriod} % 1 == 0 ? ${#numbers.formatDecimal(statistic.remainingLeftVacationDaysForPeriod, 1, 0)} : ${#numbers.formatDecimal(statistic.remainingLeftVacationDaysForPeriod, 1, 1)}"
                    ></span>
                    <span th:text="#{duration.vacationDays.remaining.two}"></span>
                  </div>
                  <div th:class="tw-mt-2">
                    <span class="tw-font-bold" th:text="${statistic.leftOvertimeForPeriod}"></span>
                    <span th:text="#{duration.overtime}"></span>
                  </div>
                </td>

                <td
                  class="tw-hidden md:tw-table-cell print:tw-table-cell"

                >
                  <div>
                    <span
                      class="tw-font-bold"
                      th:text="${statistic.leftVacationDays} % 1 == 0 ? ${#numbers.formatDecimal(statistic.leftVacationDays, 1, 0)} : ${#numbers.formatDecimal(statistic.leftVacationDays, 1, 1)}"
                    ></span>
                    <span th:text="#{duration.vacationDays}"></span>
                  </div>
                  <div class="tw-text-xs">
                    <span th:text="#{duration.vacationDays.remaining.one}"></span>
                    <span
                      class="tw-font-bold"
                      th:text="${statistic.remainingLeftVacationDays} % 1 == 0 ? ${#numbers.formatDecimal(statistic.remainingLeftVacationDays, 1, 0)} : ${#numbers.formatDecimal(statistic.remainingLeftVacationDays, 1, 1)}"
                    ></span>
                    <span th:text="#{duration.vacationDays.remaining.two}"></span>
                  </div>
                  <div th:class="tw-mt-2">
                    <span class="tw-font-bold" th:text="${statistic.leftOvertime}"></span>
                    <span th:text="#{duration.overtime}"></span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </turbo-frame>

        <div class="tw-mt-8 md:tw-mt-16 tw-flex tw-flex-col md:tw-flex-row md:tw-items-center tw-gap-8">
          <div id="pagination">
            <nav th:aria-label="#{applications.statistics.pagination.navigation.aria-label}">
              <ul class="tw-list-none tw-m-0 tw-p-0 tw-flex tw-flex-row tw-gap-x-2 tw-gap-y-4 tw-flex-wrap">
                <li th:if="${not statisticsPage.first && statisticsPage.totalPages > 7}">
                  <a
                    href="#"
                    th:href="@{/web/application/statistics (from=${period.startDateIsoValue}, to=${period.endDateIsoValue}, size=${statisticsPage.size}, page=${statisticsPage.number}, sort=${sortQuery})}"
                    class="tw-block tw-py-1 tw-text-current tw-no-underline tw-flex tw-items-center"
                    data-turbo-frame="frame-statistics"
                    data-turbo-action="advance"
                  >
                    <svg th:replace="icon/chevron-left::svg(className='tw-w-6 tw-h-6')"></svg>
                    <span class="tw-sr-only" th:text="#{pagination.page.previous}"></span>
                  </a>
                </li>
                <li th:with="isSelected=${statisticsPage.first}">
                  <a
                    href="#"
                    th:href="@{/web/application/statistics (from=${period.startDateIsoValue}, to=${period.endDateIsoValue}, size=${statisticsPage.size}, page=1, sort=${sortQuery})}"
                    class="tw-block tw-px-4 tw-py-1 tw-no-underline tw-text-inherit dark:tw-text-zinc-50 tw-rounded-md tw-border-2 tw-transition-colors"
                    th:classappend="${isSelected ? 'tw-border-neutral-600 dark:tw-border-zinc-300' : 'tw-border-neutral-300 dark:tw-border-zinc-700 hover:tw-border-neutral-400 focus:tw-border-neutral-400 hover:dark:tw-border-zinc-500 focus:dark:tw-border-zinc-500'}"
                    th:attr="aria-current=${isSelected ? 'page' : ''}"
                    th:aria-label="#{pagination.page('1')}"
                    data-turbo-frame="frame-statistics"
                    data-turbo-action="advance"
                  >
                    1
                  </a>
                </li>
                <li
                  th:if="${statisticsPage.totalPages > 7 && statisticsPage.number > 2}"
                  role="presentation"
                  class="tw-px-4 tw-py-1"
                >
                  …
                </li>
                <th:block
                  th:each="pageNumber : ${paginationPageNumbers}"
                  th:with="isSelected=${pageNumber == statisticsPage.number + 1}"
                >
                  <li
                    th:if="${not pageNumberStat.first && not pageNumberStat.last && (statisticsPage.totalPages <= 7 || pageNumber == statisticsPage.number || pageNumber == statisticsPage.number + 1 || pageNumber == statisticsPage.number + 2)}"
                  >
                    <a
                      href="#"
                      th:href="@{/web/application/statistics (from=${period.startDateIsoValue}, to=${period.endDateIsoValue}, size=${statisticsPage.size}, page=${pageNumber}, sort=${sortQuery})}"
                      class="tw-block tw-px-4 tw-py-1 tw-no-underline tw-text-inherit dark:tw-text-zinc-50 tw-rounded-md tw-border-2 tw-transition-colors"
                      th:classappend="${isSelected ? 'tw-border-neutral-600 dark:tw-border-zinc-300' : 'tw-border-neutral-300 dark:tw-border-zinc-700 hover:tw-border-neutral-400 focus:tw-border-neutral-400 hover:dark:tw-border-zinc-500 focus:dark:tw-border-zinc-500'}"
                      th:text="${pageNumber}"
                      th:attr="aria-current=${isSelected ? 'page' : ''}"
                      th:aria-label="${pageNumberStat.last ? #messages.msg('pagination.page.last', pageNumber) : #messages.msg('pagination.page', pageNumber)}"
                      data-turbo-frame="frame-statistics"
                      data-turbo-action="advance"
                    >
                      2
                    </a>
                  </li>
                </th:block>
                <li
                  th:if="${statisticsPage.totalPages > 7 && statisticsPage.number < statisticsPage.totalPages - 3}"
                  role="presentation"
                  class="tw-px-4 tw-py-1"
                >
                  …
                </li>
                <li th:if="${statisticsPage.totalPages > 1}" th:with="isSelected=${statisticsPage.last}">
                  <a
                    href="#"
                    th:href="@{/web/application/statistics (from=${period.startDateIsoValue}, to=${period.endDateIsoValue}, size=${statisticsPage.size}, page=${statisticsPage.totalPages}, sort=${sortQuery})}"
                    class="tw-block tw-px-4 tw-py-1 tw-no-underline tw-text-inherit dark:tw-text-zinc-50 tw-rounded-md tw-border-2 tw-transition-colors"
                    th:classappend="${isSelected ? 'tw-border-neutral-600 dark:tw-border-zinc-300' : 'tw-border-neutral-300 dark:tw-border-zinc-700 hover:tw-border-neutral-400 focus:tw-border-neutral-400 hover:dark:tw-border-zinc-500 focus:dark:tw-border-zinc-500'}"
                    th:text="${statisticsPage.totalPages}"
                    th:attr="aria-current=${isSelected ? 'page' : ''}"
                    th:aria-label="#{pagination.page.last(${statisticsPage.totalPages})}"
                    data-turbo-frame="frame-statistics"
                    data-turbo-action="advance"
                  >
                    3
                  </a>
                </li>
                <li th:if="${statisticsPage.totalPages > 7 && not statisticsPage.last}">
                  <a
                    href="#"
                    th:href="@{/web/application/statistics (from=${period.startDateIsoValue}, to=${period.endDateIsoValue}, size=${statisticsPage.size}, page=${statisticsPage.number + 2}, sort=${sortQuery})}"
                    class="tw-block tw-py-1 tw-text-current tw-no-underline tw-flex tw-items-center"
                    data-turbo-frame="frame-statistics"
                    data-turbo-action="advance"
                  >
                    <span class="tw-sr-only" th:text="#{pagination.page.next}"></span>
                    <svg th:replace="icon/chevron-right::svg(className='tw-w-6 tw-h-6')"></svg>
                  </a>
                </li>
              </ul>
            </nav>
          </div>
          <form
            action="#"
            th:action="@{/web/application/statistics}"
            method="get"
            class="md:tw-ml-auto tw-flex tw-items-center"
            data-turbo-frame="frame-statistics"
            data-turbo-action="advance"
          >
            <div id="pagination-form-size-inputs">
              <input type="hidden" name="from" th:value="${period.startDateIsoValue}" />
              <input type="hidden" name="to" th:value="${period.endDateIsoValue}" />
              <input type="hidden" name="page" th:value="${statisticsPage.number + 1}" />
              <input type="hidden" name="sort" th:value="${sortQuery}" />
            </div>
            <div class="tw-flex tw-items-center tw-gap-2">
              <label for="pagination-size-select" class="tw-m-0" th:text="#{pagination.page.size.label.text}">
                Zeige
              </label>
              <span>
                <select
                  name="size"
                  id="pagination-size-select"
                  th:replace="fragments/select::one(id='pagination-size-select', name='size', options=~{::pagination-size-options}, autosubmit='size-submit')"
                >
                  <th:block th:ref="pagination-size-options" th:with="size=${statisticsPage.size}">
                    <option th:if="${size < 10}" th:value="${size}" selected th:text="${size}">4</option>
                    <option value="10" th:selected="${size == 10}">10</option>
                    <option th:if="${size > 10 && size < 20}" th:value="${size}" selected th:text="${size}">14</option>
                    <option value="20" th:selected="${size == 20}">20</option>
                    <option th:if="${size > 20 && size < 40}" th:value="${size}" selected th:text="${size}">24</option>
                    <option value="40" th:selected="${size == 40}">40</option>
                    <option th:if="${size > 40}" th:value="${size}" selected th:text="${size}">44</option>
                  </th:block>
                </select>
              </span>
              <span
                id="pagination-size-hint"
                class="tw-whitespace-nowrap"
                th:text="#{pagination.page.size.total.text(${statisticsPage.totalElements}, ${#messages.msg('applications.statistics.pagination.total.text')})}"
              >
                von 42 Personen
              </span>
            </div>
            <button
              id="size-submit"
              th:text="#{pagination.page.size.button.text}"
              class="tw-ml-2 button-main"
              data-js-hidden
            >
              Aktualisieren
            </button>
          </form>
        </div>
      </div>
    </main>
  </body>
</html>
